#!/bin/bash

set -e # exit immediately if a simple command exits with a non-zero status
set -u # report the usage of uninitialized variables

# Setup env vars and folders for the errand script
source /var/vcap/jobs/sanity-test/helpers/ctl_setup.sh 'sanity-test'

<%
  etcd = link("etcd")
  etcd_protocol = etcd.p("etcd.require_ssl") ? "https" : "http"
  etcd_host = "#{etcd.instances.first.address}:etcd.p('port')"

  broker = link("etcd-cf-service-broker")
  etcd_root_username = broker.p("etcd.root_username")
  etcd_root_password = broker.p("etcd.root_password")

  etcd_root_uri = "#{etcd_protocol}://#{etcd_root_username}:#{etcd_root_password}@#{etcd_host}"

  default_expected_etcd_uri = "#{etcd_protocol}://#{etcd_host}"
-%>
export ETCD_URI="<%= etcd_root_uri %>"
export EXPECTED_ETCD_HOST=<%= p("expected_etcd_host", default_expected_etcd_uri) %>

<%
  broker = link("etcd-cf-service-broker")
  username = broker.p("username")
  password = broker.p("password")
  port     = broker.p("port")
  host     = broker.instances.first.address
-%>
export BROKER_URI=http://<%= username %>:<%= password %>@<%= host %>:<%= port %>

/var/vcap/packages/sanity-tests/bin/provision-bind-use
